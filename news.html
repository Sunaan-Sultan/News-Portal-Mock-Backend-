<!DOCTYPE html>
<html>
<body onload="init()">

<h3 id="loggedUser"></h3>

<input
  type="text"
  id="searchInput"
  placeholder="Search by title..."
  oninput="applyFilter()"
/>

<br><br>

<button onclick="location.href='create.html'">Create News</button>

<hr>

<div id="newsList"></div>

<div id="pagination"></div>

<script src="utils.js"></script>
<script>
requireLogin();

const PAGE_SIZE = 3;
let allNews = [];
let filteredNews = [];
let currentPage = 1;

document.getElementById("loggedUser").innerText =
  "Logged in as: " + getUser().name;

async function init() {
  const [news, users] = await Promise.all([
    fetch(`${API}/news`).then(r => r.json()),
    fetch(`${API}/users`).then(r => r.json())
  ]);

  // attach author name
  allNews = news.map(n => ({
    ...n,
    authorName: users.find(u => u.id === n.author_id)?.name
  }));

  filteredNews = allNews;
  render();
}

function applyFilter() {
  const q = searchInput.value.toLowerCase();
  filteredNews = allNews.filter(n =>
    n.title.toLowerCase().includes(q)
  );
  currentPage = 1;
  render();
}

function render() {
  renderNews();
  renderPagination();
}

function renderNews() {
  newsList.innerHTML = "";

  const start = (currentPage - 1) * PAGE_SIZE;
  const pageItems = filteredNews.slice(start, start + PAGE_SIZE);

  if (pageItems.length === 0) {
    newsList.innerHTML = "<p>No news found</p>";
    return;
  }

  pageItems.forEach(n => {
    newsList.innerHTML += `
      <h4>${n.title}</h4>
      <p>
        By ${n.authorName} |
        ðŸ’¬ ${n.comments.length} comments
      </p>

      <button onclick="view(${n.id})">View</button>

      ${
        n.author_id === getUser().id
          ? `<button onclick="edit(${n.id})">Edit</button>
             <button onclick="remove(${n.id})">Delete</button>`
          : ""
      }
      <hr>
    `;
  });
}

function renderPagination() {
  pagination.innerHTML = "";

  const totalPages = Math.ceil(filteredNews.length / PAGE_SIZE);

  for (let i = 1; i <= totalPages; i++) {
    pagination.innerHTML += `
      <button
        onclick="goPage(${i})"
        style="font-weight:${i === currentPage ? 'bold' : 'normal'}"
      >
        ${i}
      </button>
    `;
  }
}

function goPage(page) {
  currentPage = page;
  renderNews();
}

function view(id) {
  location.href = `detail.html?id=${id}`;
}

function edit(id) {
  location.href = `edit.html?id=${id}`;
}

function remove(id) {
  fetch(`${API}/news/${id}`, { method: "DELETE" })
    .then(() => init());
}
</script>

</body>
</html>
